<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#007bff">
    <title>Password Encryption Tool</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./icons/icon-192x192.png">
    <!-- Favicon for browser tab (using the existing 192x192 icon; works in modern browsers) -->
    <link rel="icon" href="./icons/icon-192x192.png" sizes="192x192">
    <link rel="icon" href="./icons/icon-512x512.png" sizes="512x512">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f7fa;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        input, textarea, button {
            width: 100%;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        #output {
            margin-top: 20px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 4px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        .action-buttons button {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Password Encryption Tool</h1>
        <input type="password" id="masterPassword" placeholder="Enter Master Password" required>
        <textarea id="inputText" rows="4" placeholder="Enter text to encrypt/decrypt"></textarea>
        <div class="action-buttons">
            <button onclick="encryptText()">Encrypt</button>
            <button onclick="decryptText()">Decrypt</button>
        </div>
        <div id="output"></div>
        <div class="action-buttons" style="margin-top: 10px;">
            <button onclick="copyOutput()">Copy Output</button>
            <button onclick="clearAll()">Clear</button>
        </div>
    </div>

    <script>
        // Service Worker Registration for PWA (offline support)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js', { scope: '/' })
                    .then(registration => {
                        console.log('Service Worker registered with scope: ', registration.scope);
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed: ', error);
                    });
            });
        }

        // Encryption/Decryption Logic
        async function deriveKey(password, salt) {
            const encoder = new TextEncoder();
            const keyMaterial = await crypto.subtle.importKey(
                "raw",
                encoder.encode(password),
                "PBKDF2",
                false,
                ["deriveBits", "deriveKey"]
            );
            return crypto.subtle.deriveKey(
                {
                    name: "PBKDF2",
                    salt: encoder.encode(salt),
                    iterations: 100000,
                    hash: "SHA-256"
                },
                keyMaterial,
                { name: "AES-GCM", length: 256 },
                true,
                ["encrypt", "decrypt"]
            );
        }

        async function encryptText() {
            const password = document.getElementById('masterPassword').value;
            const text = document.getElementById('inputText').value;
            if (!password || !text) {
                alert('Please enter both password and text.');
                return;
            }

            const salt = 'unique-salt'; // Use a unique salt per app/user
            const key = await deriveKey(password, salt);

            const encoder = new TextEncoder();
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const encrypted = await crypto.subtle.encrypt(
                {
                    name: "AES-GCM",
                    iv: iv
                },
                key,
                encoder.encode(text)
            );

            const encryptedArray = new Uint8Array(encrypted);
            const combined = new Uint8Array(iv.length + encryptedArray.length);
            combined.set(iv);
            combined.set(encryptedArray, iv.length);

            const base64Encrypted = btoa(String.fromCharCode(...combined));
            document.getElementById('output').innerText = `Encrypted: ${base64Encrypted}`;
        }

        async function decryptText() {
            const password = document.getElementById('masterPassword').value;
            const encryptedBase64 = document.getElementById('inputText').value;
            if (!password || !encryptedBase64) {
                alert('Please enter both password and encrypted text.');
                return;
            }

            const salt = 'unique-salt'; // Must match the salt used in encryption
            const key = await deriveKey(password, salt);

            const combined = Uint8Array.from(atob(encryptedBase64), c => c.charCodeAt(0));
            const iv = combined.slice(0, 12);
            const encrypted = combined.slice(12);

            try {
                const decrypted = await crypto.subtle.decrypt(
                    {
                        name: "AES-GCM",
                        iv: iv
                    },
                    key,
                    encrypted
                );

                const decoder = new TextDecoder();
                document.getElementById('output').innerText = `Decrypted: ${decoder.decode(decrypted)}`;
            } catch (e) {
                document.getElementById('output').innerText = 'Decryption failed. Wrong password?';
            }
        }

        // New: Copy Output to Clipboard
        function copyOutput() {
            const outputText = document.getElementById('output').innerText;
            if (!outputText) {
                alert('Nothing to copy!');
                return;
            }
            navigator.clipboard.writeText(outputText)
                .then(() => {
                    alert('Output copied to clipboard!');
                })
                .catch(err => {
                    console.error('Failed to copy: ', err);
                    alert('Failed to copy. Please try manually.');
                });
        }

        // New: Clear All Fields
        function clearAll() {
            document.getElementById('masterPassword').value = '';
            document.getElementById('inputText').value = '';
            document.getElementById('output').innerText = '';
        }
    </script>
</body>
</html>
